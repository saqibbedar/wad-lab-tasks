<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../homepage.css">
    <link rel="stylesheet" href="../styles.css">
    <title>New Arrival</title>
</head>
<body>
    <!-- top banner -->
    <div class="top-banner show">
        <p>Free Shipping on Orders Over PKR 5000</p>
        <!-- close -->
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>

    <!-- menu -->
     <div class="menu">
        <ul>
            <li>
                <a href="#">Sweaters</a>
                <a href="#">Bottoms</a>
                <a href="#">Hoodies</a>
            </li>
            <li>
                <a href="../wad-project/index.html" title="view-cart"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag-icon lucide-shopping-bag"><path d="M16 10a4 4 0 0 1-8 0"/><path d="M3.103 6.034h17.794"/><path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"/></svg>
                Cart</a>
                <!-- <a href="./pages/Login.html" title="Login"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round-icon lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                Login</a> -->
            </li>
        </ul>
     </div>

     <div class="shop-menu-mobile-version">
        <div class="shop-menu" title="menu">SHOP</div>
     </div>

    <!-- navbar -->
    <nav>
        <ul>
            <li class="shop-menu hide-on-mobile-screen" title="menu">SHOP</li>
            <li><a href="../homepage.html">LOGO</a></li>
            <li>
                <a href="../ali/ali.html" title="search"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg></a>
                
                <a href="../pages/Login.html" title="Login" class="hide-on-mobile-screen" id="user-profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round-icon lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                    <div class="loggedInUserInfo">
                        <div><strong>Account Id: </strong> <p class="account-id"></p></div>
                        <div><strong>Username: </strong> <p class="account-username"></p></div>
                         <a href="/admin/dashboard.html" class="admin-dashboard-button">Admin Dashboard</a>
                        <button class="logout_user">Logout</button>
                    </div>
                </a>

                <a href="../wad-project/index.html" title="view-cart"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag-icon lucide-shopping-bag"><path d="M16 10a4 4 0 0 1-8 0"/><path d="M3.103 6.034h17.794"/><path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"/></svg></a>
            </li>
        </ul>
    </nav>

     <!-- Product Modal -->
     <div class="product-modal-overlay">
        <form action="/api/cart" method="post" class="product-modal" data-product-id="xyz">
            <div class="modal-left">
                <img src="../../tmp/uploads/product-images/1766831766143-976d55eda696.webp" alt="">
            </div>
            <div class="modal-right">

                <!-- modal Product Info  -->
                <div class="mpi">
                    <!-- modal-product-name -->
                    <h2 class="mpn">Name</h2>
                    <!-- modal-product-price -->
                    <div class="mpp"><strong>PKR 1,000</strong></div>
                </div>
                <!-- modal-product-description -->
                <div class="mpd"><strong>Description</strong><p>...</p></div>

                <!-- product options -->
                <div class="po">
                    <!-- select color -->
                     <select name="color" id="color" class="color-select" required>
                        <option value="" disabled selected>Select Color</option>
                        <option value="Red">Red</option>
                        <option value="Blue">Blue</option>
                        <option value="Green">Green</option>
                        <option value="Black">Black</option>
                        <option value="White">White</option>
                    </select>
                    <!-- select size -->
                     <select name="size" id="size" class="size-select" required>
                        <option value="" disabled selected>Select Size</option>
                        <option value="S">Small (S)</option>
                        <option value="M">Medium (M)</option>
                        <option value="L">Large (L)</option>
                        <option value="XL">Extra Large (XL)</option>
                    </select>
                    <!-- Modal Quantity Container -->
                     <div class="mqc">
                        <p>InStock: <span class="instock-quantity">0</span></p>
                        <div>
                            <label for="quantity">Enter Quantity:</label>
                             <input type="number" name="quantity" id="quantity" class="quantity-input" min="1" value="1" required>
                        </div>
                     </div>
                </div>
                <!-- add to cart button -->
                <button type="submit" class="atcb">Add to Cart</button>
            </div>
        </form>
     </div>

    <h2 style="padding-inline: var(--p6); margin-block: var(--p6);">NEW ARRIVALS</h2>
    <div class="display-results">
        <div class="temp-display">
            <p>Loading New Arrivals...</p>
        </div>
    </div>

    <!-- footer -->
    <footer class="footer">
            <div class="footer-section">
                <h4>ABOUT US</h4>
                <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Aperiam exercitationem expedita sint dicta veniam iusto voluptatem provident corporis assumenda cum, hic beatae ab. Cupiditate repudiandae ipsa aspernatur ad, ullam distinctio.</p>
            </div>
            <div class="footer-section">
                <h4>QUICK LINKS</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Faq's</a></li>
                    <li><a href="#">Exchange & returns</a></li>
                    <li><a href="#">Shipping Policy</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Contact</a></li>
                    <li><a href="#">Track Your Order</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>FIND US ON</h4>
                <ul class="social-media">
                    <li><a href="#">Facebook</a></li>
                    <li><a href="#">Instagram</a></li>
                    <li><a href="#">Whatsapp</a></li>
                </ul>
            </div>
            <div class="footer-section footer-bottom">
                &copy; 2025 BRANDNAME.
            </div>
    </footer>
    <script>
        let productsArray = [];
        let displayResults = document.querySelector(".display-results");
        (async function searchProduct(q="true"){
            const API_URL = `/api/products/${q}`;
            try {
                const res = await fetch(API_URL);
                if(!res.ok) {
                    console.log("no results found");
                } 
                const data = await res.json()
                console.log("new-arrivals data:", data);
                if(data?.products?.length === 0){
                    console.log(data.message)
                    document.querySelector(".temp-display").textContent = "No New Product Available, visit home to see available products!";
                    return;
                }
                
                productsArray = data?.products || [];

                let collector = "";

                // r = result
                data?.products?.map(r => {
                    // console.log(r.image.url || r.image || "no image");
                    
                    return collector += `
                     <div style="cursor:pointer;" class="item" data-product-id="${r._id}" title="View ${r.name} details" onclick="openProductModal('${r._id}')">
                            <img data-src="${r.image?.url}" src="" alt="${r.name}" />
                            ${ r.isNewArrival ? "<h4 style='color: red;'>New Arrival</h4>" :    "" }
                            <h4>${r.name}</h4>
                            <p class="webkit-box"><strong>Description:</strong> ${r.description}</p>
                            <p><strong>Type:</strong> ${r.productType}</p>
                            <p><strong>InStock:</strong> <span class="inStock">${r.quantity}<span></p>
                            <p><strong>Size:</strong> ${r.size}</p>
                            <p><strong>Colors:</strong> ${r.color}</p>
                            <p><strong>Price:</strong> ${r.price} PKR</p>
                        </div>
                    `
                }
                )
                
                displayResults.innerHTML = collector;

                // a little scroll effect to add images loading smoothly
                window.scrollTo({
                    top: 5,
                    left: 0,
                    behavior: 'smooth'
                })
                
            } catch (error) {
                console.error("error while fetching new-arrivals", error);
            } 
        })()


        // 9. Open Product Modal Element Selector
        let productModalOverlay = document.querySelector(".product-modal-overlay");

        // 10. Function to open ProductModal
        function openProductModal(productId) {
            productModalOverlay.classList.add("active");
            productModalOverlay.addEventListener("click", function(e) {
                if(e.target === productModalOverlay) {
                    productModalOverlay.classList.remove("active");
                }
            });
            // console.log("Opening product modal for ID:", productId);
            // console.log("Products Array:", productsArray);
            let product = productsArray.find(p => p._id === productId);
            if(product) {
                // console.log("Product found:", product);

                // 11. Populate modal with product details
                document.querySelector(".product-modal").setAttribute("data-product-id", product._id);
                document.querySelector(".product-modal .modal-left img").src = product.image.url;
                document.querySelector(".product-modal .modal-right .mpi .mpn").textContent = product.name;
                document.querySelector(".product-modal .modal-right .mpi .mpp").innerHTML = `<strong>PKR ${product.price}</strong>`;
                document.querySelector(".product-modal .modal-right .mqc .instock-quantity").textContent = product.quantity;
                document.querySelector(".quantity-input").setAttribute("max", product.quantity);
                document.querySelector(".product-modal .modal-right .mpd p").textContent = product.description;

                // build color options
                let colorOptionCollector = `<option value="" disabled selected>Select Color</option>`;
                product.color.map(clr => 
                    colorOptionCollector += `
                        <option value="${clr}">${clr.toUpperCase()}</option>
                    `
                );
                document.querySelector(".color-select").innerHTML = colorOptionCollector;

                // build size options
                let sizeOptionCollector = `<option value="" disabled selected>Select Size</option>`;
                product.size.map(s => 
                    sizeOptionCollector += `
                        <option value="${s}">${s.toUpperCase()}</option>
                    `
                );
                document.querySelector(".size-select").innerHTML = sizeOptionCollector;


                // 12. submit form with product Id and selected options
                const productForm = document.querySelector(".product-modal");
                productForm.addEventListener("submit", async function(event) {
                    event.preventDefault();
                    
                    const formData = new FormData(productForm);
                    formData.append("productId", productId);
                    const payload = Object.fromEntries(formData.entries());
                    console.log(payload);
                    try {
                        const res = await fetch("/api/cart", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(payload)
                        });
                        let data = null;
                        if(!res.ok) {
                            data = await res.json();
                            throw new Error(data?.error || data?.message || "Error while adding product to the cart");
                        }
                        data = await res.json();
                        console.log(data.message || "cart updated");
                        productModalOverlay.classList.remove("active");
                        window.location.reload();
                    } catch (error) {
                        console.error("Error in adding product into the cart:", error);
                    };
                }, {once: true});                
            } else {
                console.error("Product not found for ID:", productId);  
            }
        }
        
    </script>
    <script src="../global.js"></script>
    <script src="../app.js" defer></script>
    <script src="../handleTopBanner.js" defer></script>
</body>
</html>