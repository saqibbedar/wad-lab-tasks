<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cart</title>
    <link rel="stylesheet" href="./index.css" />
    <link rel="stylesheet" href="../../styles.css">
</head>

<body>

    <!-- top banner -->
    <div class="top-banner show">
        <p>Free Shipping on Orders Over PKR 5000</p>
        <!-- close -->
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x close"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>

    <!-- menu -->
     <div class="menu">
        <ul>
            <li>
                <a href="#">Sweaters</a>
                <a href="#">Bottoms</a>
                <a href="#">Hoodies</a>
            </li>
            <li>
                <a href="#" title="view-cart"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag-icon lucide-shopping-bag"><path d="M16 10a4 4 0 0 1-8 0"/><path d="M3.103 6.034h17.794"/><path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"/></svg>
                Cart</a>
                <!-- <a href="../login/index.html" title="Login"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round-icon lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                Login</a> -->
            </li>
        </ul>
     </div>

     <div class="shop-menu-mobile-version">
        <div class="shop-menu" title="menu">SHOP</div>
     </div>

    <!-- navbar -->
    <nav>
        <ul>
            <li class="shop-menu hide-on-mobile-screen">SHOP</li>
            <li><a href="/">LOGO</a></li>
            <li>
                <a href="../search/index.html"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg></a>

                <a href="../login/index.html" title="Login" id="user-profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-round-icon lucide-user-round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                    <div class="loggedInUserInfo">
                        <div><strong>Account Id: </strong> <p class="account-id"></p></div>
                        <div><strong>Username: </strong> <p class="account-username"></p></div>
                        <a href="/admin/dashboard.html" class="admin-dashboard-button">Admin Dashboard</a>
                        <button class="logout_user">Logout</button>
                    </div>
                </a>

                <a href="#" class="cart-icon-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag-icon lucide-shopping-bag"><path d="M16 10a4 4 0 0 1-8 0"/><path d="M3.103 6.034h17.794"/><path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"/></svg>
                <!-- <span class="cart-size">0</span> -->
                </a>
            </li>
        </ul>
    </nav>

    <main>
        <div class="page-container">
            <h1 class="page-title">Your Product Cart</h1>

            <div class="table-container">
                <table>
                    <tr>
                        <th>S.No.</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>NewArrival</th>
                        <th>Size</th>
                        <th>Color</th>  
                        <th>Quantity</th>  
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                    <tr class="loading-row">
                        <td colspan="9" style="text-align: center;">Loading products...</td>
                    </tr>
                </table>
            </div>

            <br>
            <br>
            <div class="cart-explore-products-buttons">
                <a href="/"><button type="button">Browse More</button></a>
                <a href="../new-arrival/index.html"><button type="button">New Arrivals</button></a>
                <a href="../search/index.html"><button type="button">Search</button></a>
            </div>

            <br>
            <br>
            <div class="cart-total">
                <h3 class="deliveryCharges">Delivery Charges: <span>0</span></h3><br>
                <h3 class="subtotal">SubTotal: <span>0</span></h3><br>
                <h3 class="totalAmount">Total Amount: <span>0</span></h3>
            </div>
        </div>
    </main>

    <!-- footer -->
    <footer class="footer">
            <div class="footer-section">
                <h4>ABOUT US</h4>
                <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Aperiam exercitationem expedita sint dicta veniam iusto voluptatem provident corporis assumenda cum, hic beatae ab. Cupiditate repudiandae ipsa aspernatur ad, ullam distinctio.</p>
            </div>
            <div class="footer-section">
                <h4>QUICK LINKS</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Faq's</a></li>
                    <li><a href="#">Exchange & returns</a></li>
                    <li><a href="#">Shipping Policy</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Contact</a></li>
                    <li><a href="#">Track Your Order</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>FIND US ON</h4>
                <ul class="social-media">
                    <li><a href="#">Facebook</a></li>
                    <li><a href="#">Instagram</a></li>
                    <li><a href="#">Whatsapp</a></li>
                </ul>
            </div>
            <div class="footer-section footer-bottom">
                &copy; 2025 BRANDNAME.
            </div>
        </footer>
    <script src="../../global.js"></script>
    <script>
        
        
        // 1. cart data holder
        let cart = null;
        
        // 2. fetch user cart
        async function fetchUserCart() {
            // 2.1 fetching
            const response = await fetch("/api/cart");
            if(!response.ok) {
                console.error("Error while fetching user cart");
                document.querySelector(".loading-row").style.display = "table-row";
                document.querySelector(".loading-row td").textContent = "Cart is Empty!";
                return
            }
            
            // 2.2 If response was okay save data and check if data is correct
            const data = await response.json();
            if (data) {

                // 2.3 Get cart from backend data
                cart = data.cart;
                // const subTotal = cart.products.reduce((sum, p) => {
                //     return sum + (p.productId.price * p.quantity);
                // }, 0);
                
                // 2.4 Update basic cart info
                document.querySelector(".deliveryCharges span").textContent = Boolean(Number(cart.deliveryCharges) === 0 && Number(cart.totalAmount > 0) && cart.products.length > 0) ? "ðŸŽ‰ Free Delivery coupon was applied to your order!" : cart.products.length > 0 ? cart.deliveryCharges : 0;
                document.querySelector(".subtotal span").textContent = cart.totalAmount;
                document.querySelector(".totalAmount span").textContent = Number(cart.totalAmount) + Number(cart.products.length > 0 ? cart.deliveryCharges : 0);
                
                // 2.5 Table Management
                let collector = "";
                if(cart.products.length > 0) {

                    // 2.6 save cartSize ==> feature not added for now
                    localStorage.setItem("cart-size", `${cart.products.length}`);

                    // 2.7 build table body
                    cart.products.map((p, index) => {
    
                        return collector += `
                        <tr data-cart-item-id="${cart._id}">
                            <td>${index+1}</td>
                            <td><img src="${p.productId.image.url}"/></td>
                            <td>${p.productId.name || "N/A"}</td>
                            <td>${p.productId.isNewArrival? "Yes" : "No"}</td>
                            <td>${p.size}</td>
                            <td>${p.color}</td>  
                            <td>${p.quantity}</td>  
                            <td>${Number(p.productId.price)}</td>
                            <td>
                                <input type="button" value="Remove" onclick="removeItemFromCart('${cart._id}', '${p.productId._id}', '${p._id}')">
                            </td>
                        </tr>
                        `
                    }
                    );

                    // 2.8 Hide loading row and display body to table 
                    document.querySelector(".loading-row").style.display = "none";
                    document.querySelector(".table-container table").insertAdjacentHTML("beforeend", collector)
                    console.log(cart)
                } else {
                    console.log("Hello")
                    document.querySelector(".loading-row").style.display = "table-row";
                    document.querySelector(".loading-row td").textContent = "Cart is Empty!";
                }
            } else {
                document.querySelector(".loading-row").style.display = "table-row";
                document.querySelector(".loading-row td").textContent = "Cart is Empty!";
            }
        }
        
        // 3. fetch user cart only if user is loggedIn
        if(localStorage.getItem("user_login_info")) {
            fetchUserCart();
        } else {
            // 3.1 if not loggedIn update message for Login
            document.querySelector(".loading-row").style.display = "table-row";
            document.querySelector(".loading-row td").textContent = "Please Login To Get Your Product Cart!";
        }
        
        // 4. Remove product from cart
        async function removeItemFromCart(cartId, productId, cartItemId) {
            // 4.1 Item removal response
            const res = await fetch(`/api/cart?cartId=${cartId}&productId=${productId}&cartItemId=${cartItemId}`, {
                method: "DELETE"
            });

            // 4.2 data holder
            let data = null;

            // 4.3 if there was any issue in removing cart, console errors
            if(!res.ok) {
                data = await res.json();
                console.error(data.error || "Error while removing product from cart")
            }
            
            // 4.4 No error, get the data
            data = await res.json();
            
            // 4.5 cart item removed, display data for any message from server and reload window for fresh user cart
            if(data) {
                console.log(data);
                window.location.reload();
            }
        }
        
    </script>
    <script src="../../handleTopBanner.js" defer></script>
</body>
</html>