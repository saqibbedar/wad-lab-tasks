<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
      .table-container table {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: max-content;
        min-width: 100%;
      }
      .table-container td,
      .table-container th {
        white-space: nowrap;
        border: 1px solid #ddd;
        padding: 8px;
      }
      .table-container tr:hover {
        background-color: #e7e7e7;
      }
      .table-container th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #000000;
        color: white;
      }
      .table-container img {
        max-width: 50px;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 3px;
        object-fit: cover;
        object-position: top;
      }
      .description-cell {
        max-width: 100px;
        width: 100%;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .required {
            color: red;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: fit-content;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
        }
        input, textarea {
            width: 100%;
        }
        div, label {
            display: flex;
        }
        div {
            gap: 8px;
        }
        label {
            gap: 4px;
        }
        .edit-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #00000059;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 100%;
            height: 100dvh;
            display: none;
            justify-content: center;
            align-items: center;
        }
    </style>
    <title>Product List</title>
  </head>
  <body style="position: relative;">
    <button onclick="window.location.href='/'">Home</button>
    <button onclick="window.location.href='/public/admin/dashboard.html'">Dashboard</button>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Product List</h1>
        <div>
            <button type="button" onclick="window.location.reload()">Refresh</button>
            <a href="./add-product.html"><button type="button">+ New Product</button></a>
        </div>
    </div>
    <div class="table-container">
        <table>
          <tr>
            <th>S.No.</th>
            <th>Image</th>
            <th>Code</th>
            <th>Type</th>
            <th>Name</th>
            <th>Description</th>
            <th>NewArrival</th>
            <th>Size</th>
            <th>Color</th>  
            <th>Price</th>
            <th>Quantity</th>  
            <th>Action</th>
          </tr>
          <tr id="loading-row">
            <td colspan="12" style="text-align: center;">Loading products...</td>
          </tr>
        </table>
    </div>

    <div class="edit-window">
        <form enctype="multipart/form-data">
            <!-- <input type="hidden" name="_method" value="PUT"> -->
            <div>
                <label for="image">Image <span class="required">*</span> </label> <input type="file" accept="image/png, image/jpeg, image/webp" name="image" id="image" placeholder="add image" required>
            </div>
            <div>
                <label for="isNewArrival">IsNewArrival? <span class="required">*</span> </label> <input type="text" name="isNewArrival" id="isNewArrival" placeholder="yes or no" required>
            </div>
            <div>
                <label for="productType">Type <span class="required">*</span> </label> <input type="text" name="productType" id="productType" placeholder="e.g., Sweaters, Hoodies..." required>
            </div>
            <div>
                <label for="productCode">Code <span class="required">*</span> </label> <input type="text" name="productCode" id="productCode" placeholder="e.g., WWXS001, WWXH001..." required>
            </div>
            <div>
                <label for="name">Name <span class="required">*</span> </label> <input type="text" name="name" id="name" placeholder="e.g., Washed Cable Knit Sweater..." required>
            </div>
            <div>
                <label for="description">Description <span class="required">*</span> </label> <textarea name="description" id="description" cols="30" rows="10" placeholder="Enter product description..." required></textarea>
            </div>
            <div>
                <label for="size">Size (To add many use comma) <span class="required">*</span> </label> <input type="text" name="size" id="size" placeholder="e.g, XS, S, M, L, XL..." required>
            </div>
            <div>
                <label for="color">Color (To add many use comma)<span class="required">*</span></label> <input type="text" name="color" id="color" placeholder="e.g., red, blue..." required>
            </div>
            <div>
                <label for="quantity">Quantity <span class="required">*</span></label> <input type="Number" name="quantity" id="quantity" min="0" placeholder="e.g., 1-100..." required>
            </div>
            <div>
                <label for="price">Price <span class="required">*</span></label> <input type="Number" name="price" id="price" min="0" placeholder="e.g., 1000-5000..." required>
            </div>
            <input type="submit">
        </form>
    </div>

    <script>
        // fetch products and display in table
        let table = document.querySelector("table");
        
        const editWindow = document.querySelector(".edit-window");
        const editForm = document.querySelector(".edit-window form");
        let isUpdating = false; // to track if any product is being updated
        let isSubmitting = false; // to prevent multiple submissions

        let currentProductIdForUpdate = null;

        async function fetchProducts() {
            try {
                document.getElementById("loading-row").style.display = "table-row";
                const res = await fetch("/api/products");
                if(!res.ok) {
                    throw new Error(res.error || "Failed to fetch products");
                }
                const data = await res.json();
                let collector = "";
                data.forEach((product, index) => {
                    collector += `
                    <tr data-id="product-row-${product._id}">
                        <td>${index + 1}</td>
                        <td>${product.image && product.image.url ? `<img src="${product.image.url}" alt="Product Image" />` : "N/A"}</td>
                        <td>${product.productCode || "N/A"}</td>
                        <td>${product.productType || "N/A"}</td>
                        <td>${product.name || "N/A"}</td>
                        <td class="description-cell">${product.description || "N/A"}</td>
                        <td>${product.isNewArrival ? "Yes" : "No"}</td>
                        <td>${product.size || "N/A"}</td>
                        <td>${product.color || "N/A"}</td>
                        <td>PKR ${product.price || "N/A"}</td>
                        <td>${product.quantity || "N/A"}</td>
                        <td><button onclick='editProduct(${JSON.stringify(product._id)})'>Edit</button> <button onclick='deleteProduct(${JSON.stringify(product._id)})'>Delete</button></td>
                    </tr>
                        `;
                    });
                    document.getElementById("loading-row").style.display = "none";
                    table.insertAdjacentHTML("beforeend", collector);
            } catch (error) {
                console.error("Error fetching products:", error);
                alert("Failed to fetch products.");
            } finally {
                document.getElementById("loading-row").style.display = "none";
            }
        }
        fetchProducts();

        // TODO: Add event listeners for Edit and Delete buttons
        function editProduct(productId) {

            isUpdating = true;
            isSubmitting = false;
            currentProductIdForUpdate = productId;
            editWindow.style.display = "flex";

            const row = document.querySelector(`tr[data-id="product-row-${productId}"]`);
            // console.log(row);
            if (!row) return;
            const cells = row.getElementsByTagName("td");
            document.getElementById("image").value = ""; // prefill file with existing image
            document.getElementById("productCode").value = cells[2].innerText;
            document.getElementById("productType").value = cells[3].innerText;
            document.getElementById("name").value = cells[4].innerText;
            document.getElementById("description").value = cells[5].innerText;
            document.getElementById("isNewArrival").value = cells[6].innerText;
            document.getElementById("size").value = cells[7].innerText; 
            document.getElementById("color").value = cells[8].innerText;
            document.getElementById("price").value = cells[9].innerText.replace("PKR ", "");
            document.getElementById("quantity").value = cells[10].innerText;
        }

        editForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!currentProductIdForUpdate || isSubmitting) return;

            isSubmitting = true;
            console.log(editForm)

            const formData = new FormData(editForm);

            try {
                const res = await fetch(`/api/products/${currentProductIdForUpdate}`, {
                method: "PUT",
                body: formData
                });

                if (!res.ok) throw new Error("Failed to update product");

                alert("Product updated successfully");
                window.location.reload();

            } catch (err) {
                console.error(err);
                alert("Update failed");
            } finally {
                isSubmitting = false;
                currentProductId = null;
                editWindow.style.display = "none";
            }
        });
        
        function deleteProduct(productId) {
            try {
                const confirmDelete = confirm("Are you sure you want to delete this product?");
                if (!confirmDelete) return;

                fetch(`/api/products/${productId}`, {
                    method: "DELETE"
                })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to delete product");
                    return res.json();
                })
                .then(data => {
                    alert("Product deleted successfully");
                    // Remove the product row from the table
                    const row = document.querySelector(`tr[data-id="product-row-${productId}"]`);
                    if (row) row.remove();
                })
                .catch(err => {
                    console.error(err);
                    alert("Deletion failed");
                });
            } catch (error) {
                console.error("Error deleting product:", error);
                alert("An error occurred while deleting the product.");
            }
        }
        
        editWindow.addEventListener("click", function(event) {
            if (event.target === this) {
                this.style.display = "none";
            }
            if(isUpdating) {
                isUpdating = false;
                document.querySelector(".edit-window form").removeEventListener("submit", () => {});
            }
        });
    </script>
  </body>
</html>
